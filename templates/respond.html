{% extends "base.html" %}

{% block title %}招待への回答 | スマートイベントプランナー{% endblock %}

{% block extra_head %}
  {{ super() }}
  <style>
    .respond-card {
      max-width: 640px;
      margin: 0 auto;
    }

    .slot-container {
      max-height: 320px;
      overflow-y: auto;
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(255, 255, 255, 0.92);
      padding: 18px;
      display: grid;
      gap: 18px;
    }

    .slot-group {
      display: grid;
      gap: 10px;
    }

    .slot-date {
      font-weight: 700;
      color: var(--accent-strong);
    }

    .slot-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      background: rgba(14, 165, 233, 0.1);
      color: var(--text-primary);
      font-weight: 600;
    }

    .respond-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .form-alert {
      margin-top: 16px;
      padding: 12px 14px;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(248, 113, 113, 0.4);
      background: rgba(254, 226, 226, 0.6);
      color: #991b1b;
      font-size: 0.9rem;
    }
  </style>
{% endblock %}

{% block header_actions %}{% endblock %}

{% block content %}
  <section class="surface-card form-card respond-card">
    <h1>{{ event.title }}</h1>
    <p>お名前を入力し、参加可否を選択してください。参加可能な日時があればチェックを入れて送信します。</p>

    {% if error %}
      <div class="form-alert" role="alert">{{ error }}</div>
    {% endif %}

    <form method="post" id="respond-form">
      <input type="hidden" name="action" id="respond-action" value="{{ 'attend' if show_slots else '' }}">
      <div class="input-field">
        <label for="invitee-name">氏名</label>
        <input type="text" id="invitee-name" name="invitee_name" value="{{ invitee_name or '' }}" required>
      </div>

      <div class="respond-actions" id="attendance-buttons" style="{{ 'display: none;' if show_slots else '' }}">
        <button type="button" class="btn btn-primary" onclick="chooseAttend()">参加する</button>
        <button type="button" class="btn btn-ghost" onclick="submitDecline()">参加しない</button>
      </div>

      <div id="availability-section" style="{{ '' if show_slots else 'display: none;' }}">
        <div class="slot-container">
          {% for day, slots in time_slots.items() %}
            <div class="slot-group">
              <div class="slot-date">{{ day }}</div>
              {% for slot in slots %}
                <label class="slot-item">
                  <input type="checkbox" name="available_slots" value="{{ slot.value }}" {% if slot.value in selected_slots %}checked{% endif %}>
                  {{ slot.display }}
                </label>
              {% endfor %}
            </div>
          {% endfor %}
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 24px;">希望日時を送信</button>
      </div>
    </form>
  </section>
{% endblock %}

{% block extra_scripts %}
  {{ super() }}
  <script>
    const respondForm = document.getElementById('respond-form');
    const respondAction = document.getElementById('respond-action');
    const nameInput = document.getElementById('invitee-name');
    const attendanceButtons = document.getElementById('attendance-buttons');
    const availabilitySection = document.getElementById('availability-section');

    function ensureNameEntered() {
      if (nameInput.value.trim()) {
        return true;
      }
      nameInput.focus();
      nameInput.reportValidity();
      return false;
    }

    function chooseAttend() {
      if (!ensureNameEntered()) return;
      respondAction.value = 'attend';
      attendanceButtons.style.display = 'none';
      availabilitySection.style.display = '';
    }

    function submitDecline() {
      if (!ensureNameEntered()) return;
      respondAction.value = 'decline';
      respondForm.requestSubmit();
    }

    if (respondAction.value === 'attend') {
      attendanceButtons.style.display = 'none';
      availabilitySection.style.display = '';
    }
  </script>
{% endblock %}
