{% extends "base.html" %}

{% block title %}招待の集計結果 | スマートイベントプランナー{% endblock %}

{% block extra_head %}
  {{ super() }}
  <style>
    .result-card {
      display: grid;
      gap: 28px;
    }

    .result-summary {
      background: linear-gradient(135deg, rgba(14, 165, 233, 0.28), rgba(14, 116, 144, 0.18));
      border-radius: var(--radius-lg);
      padding: 28px;
      color: var(--text-primary);
      box-shadow: var(--shadow-md);
      display: grid;
      gap: 10px;
    }

    .result-summary strong {
      font-size: 1.4rem;
    }

    .details-table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(255, 255, 255, 0.96);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-md);
    }

    .details-table th,
    .details-table td {
      padding: 14px 16px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.25);
    }

    .details-table thead th {
      background: rgba(15, 23, 42, 0.85);
      color: var(--text-inverse);
    }

    .heatmap-wrapper {
      overflow-x: auto;
      background: rgba(255, 255, 255, 0.94);
      padding: 18px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
    }

    .heatmap-table {
      border-collapse: collapse;
      width: max-content;
    }

    .heatmap-table th,
    .heatmap-table td {
      padding: 8px 14px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      text-align: center;
      font-size: 0.9rem;
    }

    .heatmap-table th {
      background: rgba(15, 23, 42, 0.85);
      color: var(--text-inverse);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .legend {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .legend-bar {
      height: 12px;
      width: 120px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(226, 232, 240, 1) 0%, rgba(14, 165, 233, 1) 100%);
      border: 1px solid rgba(148, 163, 184, 0.45);
    }
  </style>
{% endblock %}

{% block content %}
  <section class="surface-card result-card">
    <div>
      <span class="tag">RESULT</span>
      <h1 style="margin-top: 12px;">招待の集計結果</h1>
    </div>

    {% if result.error %}
      <div class="empty-state">
        <p>{{ result.error }}</p>
      </div>
    {% elif result.message %}
      <div class="empty-state">
        <p>{{ result.message }}</p>
      </div>
    {% else %}
      <div class="result-summary">
        <p><strong>{{ result.event_title }}</strong> の最適な日時は…</p>
        <strong>{{ result.best_schedule }}</strong>
        <p>参加率：<strong>{{ result.participation_rate }}</strong>（{{ result.attendees }} / {{ result.total_invitees }}名）</p>
      </div>

      <div>
        <h2>全候補日時の集計</h2>
        <table class="details-table">
          <thead>
            <tr><th>候補日時</th><th>参加可能人数</th></tr>
          </thead>
          <tbody>
            {% for item in result.details %}
              <tr>
                <td data-label="候補日時">{{ item.time }}</td>
                <td data-label="参加可能人数">{{ item.count }} 人</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div>
        <h2>可用人数ヒートマップ</h2>
        <div class="heatmap-wrapper">
          <table id="heatmap" class="heatmap-table"></table>
        </div>
        <div class="legend"><span>0</span><div class="legend-bar"></div><span>最大</span></div>
      </div>
    {% endif %}

    <div class="inline-actions" style="justify-content: flex-end;">
      <a href="{{ url_for('invite') }}" class="btn btn-secondary">別の招待を作成</a>
    </div>
  </section>
{% endblock %}

{% block extra_scripts %}
  {{ super() }}
  <script>
    (function() {
      const raw = {{ result.details|tojson }};
      if (!raw || !raw.length) { return; }

      const grouped = {};
      let max = 0;
      raw.forEach(({ time, count }) => {
        const [date, hm] = time.split(' ');
        grouped[date] = grouped[date] || {};
        grouped[date][hm] = count;
        if (count > max) { max = count; }
      });

      const dates = Object.keys(grouped);
      const times = Array.from(new Set(raw.map(({ time }) => time.split(' ')[1]))).sort();

      const table = document.getElementById('heatmap');
      if (!table) { return; }

      const thead = document.createElement('thead');
      const headRow = document.createElement('tr');
      headRow.appendChild(document.createElement('th'));
      times.forEach(t => {
        const th = document.createElement('th');
        th.textContent = t;
        headRow.appendChild(th);
      });
      thead.appendChild(headRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      dates.forEach(date => {
        const tr = document.createElement('tr');
        const th = document.createElement('th');
        th.textContent = date;
        tr.appendChild(th);

        times.forEach(t => {
          const td = document.createElement('td');
          const count = grouped[date][t] || 0;
          td.textContent = count;
          if (max > 0) {
            const ratio = count / max;
            const r = 14;
            const g = Math.round(165 * ratio);
            const b = Math.round(233 * ratio);
            td.style.background = `rgb(${r}, ${g}, ${b})`;
            td.style.color = count ? '#0b1120' : '#64748b';
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
    })();
  </script>
{% endblock %}
